name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # PHASE 1 CHECKS
      - name: 1Ô∏è‚É£ Check Python Syntax
        run: |
          echo "üîç Checking Python syntax..."
          python -m compileall -q .
          echo "‚úÖ Syntax check passed!"
      
      - name: 2Ô∏è‚É£ Install Dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          pip install flake8 pytest pytest-cov bandit safety
          echo "‚úÖ Dependencies installed!"
      
      - name: 3Ô∏è‚É£ Lint Code
        run: |
          echo "üßπ Running code linter..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          echo "‚úÖ Linting completed!"
      
      # PHASE 2 - CODE COVERAGE
      - name: 4Ô∏è‚É£ Run Tests with Coverage
        run: |
          echo "üß™ Running tests with coverage tracking..."
          pytest --cov=. --cov-report=term-missing --cov-report=json --cov-report=html -v
          echo "‚úÖ Tests completed!"
      
      - name: 4Ô∏è‚É£ Extract Coverage Percentage
        id: coverage
        run: |
          COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "üìä Code Coverage: $COVERAGE%"
      
      # PHASE 2 - SECURITY SCANNING
      - name: 5Ô∏è‚É£ Security Scan - Bandit
        id: bandit
        continue-on-error: true
        run: |
          echo "üîí Running security scan (Bandit)..."
          bandit -r . -f json -o bandit-report.json --exclude './tests/*,./venv/*' || true
          ISSUES=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len(data.get('results', [])))")
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "üîí Security issues found: $ISSUES"
      
      - name: 6Ô∏è‚É£ Security Scan - Safety
        id: safety
        continue-on-error: true
        run: |
          echo "üõ°Ô∏è Checking for vulnerable dependencies..."
          pip freeze > requirements-check.txt
          safety check -r requirements-check.txt --json > safety-report.json || true
          VULNS=$(python -c "import json; data=json.load(open('safety-report.json')); print(len(data.get('vulnerabilities', [])))" || echo "0")
          echo "vulnerabilities=$VULNS" >> $GITHUB_OUTPUT
          echo "üõ°Ô∏è Vulnerabilities found: $VULNS"
      
      # Upload coverage report as artifact
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
  
  notify:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Send Enhanced Discord Notification
        env:
          BUILD_RESULT: ${{ needs.build.result }}
          COVERAGE: ${{ needs.build.outputs.coverage }}
          BANDIT_ISSUES: ${{ needs.build.outputs.bandit.issues }}
          SAFETY_VULNS: ${{ needs.build.outputs.safety.vulnerabilities }}
        run: |
          # Determine status
          if [ "$BUILD_RESULT" = "success" ]; then
            STATUS="success"
          elif [ "$BUILD_RESULT" = "failure" ]; then
            STATUS="failure"
          else
            STATUS="cancelled"
          fi
          
          echo "üì§ Sending enhanced notification..."
          echo "   Status: $STATUS"
          echo "   Coverage: ${COVERAGE:-N/A}%"
          echo "   Security Issues: ${BANDIT_ISSUES:-0}"
          echo "   Vulnerabilities: ${SAFETY_VULNS:-0}"
          
          curl -X POST https://unsecluding-incudate-frida.ngrok-free.dev/webhook-test/ci-monitor \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"$STATUS\",
              \"coverage\": \"${COVERAGE:-0}\",
              \"security_issues\": \"${BANDIT_ISSUES:-0}\",
              \"vulnerabilities\": \"${SAFETY_VULNS:-0}\",
              \"repository\": \"${{ github.repository }}\",
              \"branch\": \"${{ github.ref_name }}\",
              \"author\": \"${{ github.actor }}\",
              \"commit\": \"${{ github.sha }}\",
              \"workflow\": \"${{ github.workflow }}\",
              \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }"
          
          echo "‚úÖ Enhanced notification sent!"
