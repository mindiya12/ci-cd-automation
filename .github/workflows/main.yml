name: CI Build Monitor - Phase 1

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      # PHASE 1 - PART 1: Syntax Validation
      - name: 1Ô∏è‚É£ Check Python Syntax
        run: |
          echo "üîç Checking Python syntax..."
          python -m compileall -q .
          echo "‚úÖ Syntax check passed!"
      
      # PHASE 1 - PART 2: Linting
      - name: 2Ô∏è‚É£ Install Linter
        run: |
          echo "üì¶ Installing flake8..."
          pip install flake8
      
      - name: 2Ô∏è‚É£ Lint Code
        run: |
          echo "üßπ Running code linter..."
          # Stop on syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Show other issues but don't fail
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
          echo "‚úÖ Linting completed!"
      
      # PHASE 1 - PART 3: Testing
      - name: 3Ô∏è‚É£ Install Test Framework
        run: |
          echo "üì¶ Installing pytest..."
          pip install pytest
      
      - name: 3Ô∏è‚É£ Run Tests
        run: |
          echo "üß™ Running tests..."
          if [ -d "tests" ] || ls test_*.py 2>/dev/null; then
            pytest -v
          else
            echo "‚ö†Ô∏è  No tests found. Create test files to enable testing."
            echo "   Example: Create 'test_example.py' or 'tests/' folder"
          fi
          echo "‚úÖ Testing phase completed!"
  
  notify:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Send Discord Notification
        env:
          BUILD_RESULT: ${{ needs.build.result }}
        run: |
          if [ "$BUILD_RESULT" = "success" ]; then
            STATUS="success"
          elif [ "$BUILD_RESULT" = "failure" ]; then
            STATUS="failure"
          else
            STATUS="cancelled"
          fi
          
          echo "üì§ Sending notification with status: $STATUS"
          
          curl -X POST https://YOUR-NGROK-URL/webhook-test/ci-monitor \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"$STATUS\",
              \"repository\": \"${{ github.repository }}\",
              \"branch\": \"${{ github.ref_name }}\",
              \"author\": \"${{ github.actor }}\",
              \"commit\": \"${{ github.sha }}\",
              \"workflow\": \"${{ github.workflow }}\",
              \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }"
          
          echo "‚úÖ Notification sent!"
