name: CI Build Monitor

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3         
      
      - name: Set up Python
        uses: actions/setup-python@v4       
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install pytest                
          pip install -r requirements.txt   
      
      - name: Run tests                     
        run: python -m pytest test.py     
  
  notify:
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Determine status and send notification
        env:
          BUILD_RESULT: ${{ needs.build.result }}
        run: |
          if [ "$BUILD_RESULT" = "success" ]; then
            STATUS="success"
          elif [ "$BUILD_RESULT" = "failure" ]; then
            STATUS="failure"
          else
            STATUS="unknown"
          fi
          
          curl -X POST https://unsecluding-incudate-frida.ngrok-free.dev/webhook-test/ci-monitor \
            -H "Content-Type: application/json" \
            -d "{
              \"status\": \"$STATUS\",
              \"repository\": \"${{ github.repository }}\",
              \"branch\": \"${{ github.ref_name }}\",
              \"author\": \"${{ github.actor }}\",
              \"commit\": \"${{ github.sha }}\",
              \"workflow\": \"${{ github.workflow }}\",
              \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }"

